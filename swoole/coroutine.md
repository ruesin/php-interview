# 协程

Coroutine（协程）是一种用户态的轻量级线程，又称微线程。

协程不是进程或线程，其执行过程更类似于子例程，或者说不带返回值的函数调用。子程序就是协程的一种特例。

协程就是一个函数，一个特殊的函数——可以在某个地方挂起，并且可以重新在挂起处继续运行。

相对子例程而言，协程更为一般和灵活，但在实践中使用没有子例程那样广泛。

子程序，或者称为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，最后是A执行完毕。

所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。子程序调用总是一个入口，一次返回，调用顺序是明确的。

而协程的调用和子程序不同，执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似CPU的中断。

一个进程可以包含多个线程，一个线程也可以包含多个协程，也就是说，一个线程内可以有多个那样的特殊函数在运行。但是，一个线程内的多个协程的运行是串行的。如果有多核CPU的话，多个进程或一个进程内的多个线程是可以并行运行的，但是一个线程内的多个协程却绝对串行的，无论有多少个CPU（核）。协程虽然是一个特殊的函数，但仍然是一个函数。一个线程内可以运行多个函数，但是这些函数都是串行运行的。当一个协程运行时，其他协程必须挂起。

一个程序可以包含多个协程，可以对比与一个进程包含多个线程。多个线程相对独立，有自己的上下文，切换受系统控制；而协程也相对独立，有自己的上下文，但是其切换由自己控制，由当前协程切换到其他协程由当前协程来控制。

协程的特点在于是一个线程执行，和多线程比，最大的优势就是协程极高的执行效率，因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显；第二个优势就是不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。

因为协程是一个线程执行，可以通过多进程+协程的方式。既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。

并行(parallel)：指在同一时刻，有多条指令在多个处理器上同时执行。（多进程）

并发(concurrency)：指在同一时刻只能有一条指令执行，但多个进程指令被快速的轮换执行，使得在宏观上具有多个进程同时执行的效果，但在微观上并不是同时执行的，只是把时间分成若干段，使多个进程快速交替的执行。（协程）

网络爬虫主要受到网络延迟和本地运行效率的限制，传统的基于多线程的网络爬虫架构主要为了消除网络延迟而没有考虑到本地运行效率。在高并发的条件下，多线程架构爬虫由于上下文切换开销增大而导致本地运行效率降低，同时使得网络利用率下降，单进程内网络IO阻塞导致CPU、IO无法充分利用。
